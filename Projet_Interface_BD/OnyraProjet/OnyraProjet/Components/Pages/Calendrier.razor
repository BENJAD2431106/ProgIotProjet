@page "/Calendrier"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using System.Globalization
@using Authentication
@using OnyraProjet.Models
@using System.Security.Claims

@inject OnyraProjet.Services.InscriptionService inscriptionService
@inject OnyraProjet.Services.CalendrierService calendrierService
@inject AuthenticationStateProvider AuthService
@rendermode InteractiveServer
@* Pour moi : mettre mes bind-value, faire mon userSession afin de capter mes infos dutilisateur et lesmettre dasnmon insert, et enfin capter les erreurs. AVANT 20 NOV/ *@

<h3>Calendrier</h3>
<div>
    <button @onclick="PrevMonth">◀️</button>
    <strong>@currentMonth.ToString("MMMM yyyy", CultureInfo.GetCultureInfo("fr-FR"))</strong>
    <button @onclick="NextMonth">▶️</button>
</div>

<table style="margin-top:10px; border-collapse: collapse;">
    <thead>
        <tr>
            @foreach (var dayName in dayNames)
            {
                <th style="padding:15px; border:1px solid #ccc;">@dayName</th>
            }
        </tr>
    </thead>
    <tbody>
        @for (int week = 0; week < 6; week++)
        {
            <tr>
                @for (int day = 0; day < 7; day++)
                {
                    var index = week * 7 + day;
                    var date = days[index];
                    var isCurrentMonth = date.Month == currentMonth.Month;
                    var isSelected = date == selectedDate;

                    <td style="@GetCellStyle(isCurrentMonth, isSelected)" @onclick="() => SelectDay(date)">
                        @date.Day
                    </td>
                }
            </tr>
        }
    </tbody>
</table>

@if (selectedDate != DateTime.MinValue)
{
    <div style="margin-top:15px;">
        <h4>Ajouter des données pour le @selectedDate.ToString("dd MMMM yyyy", CultureInfo.GetCultureInfo("fr-FR"))</h4>
        <EditForm Model="nouveauCalendrier">
            <div class="form-group">
                <label for="ressenti">Votre Ressenti :</label>
                <InputNumber class="form-control" id="ressenti"
                             @bind-Value=nouveauCalendrier.Ressenti></InputNumber>
            </div>
            <div class="form-group">
                <label for="hCoucherr">Date Du Coucher</label>
                <InputDate class="form-control" id="hCoucher"
                           @bind-Value=dateCoucher></InputDate>
                <label for="hCoucher">Heure Du Coucher</label>
                <input type="time" id="hhcoucher" @bind=heureCoucher />
            </div>
            <div class="form-group">
                <label for="hLeverr">Heure Du Réveil</label>
                <InputDate class="form-control" id="hReveil"
                           @bind-Value=dateLever> </InputDate>
                <label for="hLever">Heure Du Coucher</label>
                <input type="time" id="hhcoucher" @bind=heureLever />
            </div>
            <div class="form-group">
                <label for="nbReveil">Le nombre de réveil</label>
                <InputNumber class="form-control" id="nbReveil"
                             @bind-Value=nouveauCalendrier.NbreReveil></InputNumber>
            </div>
            <div class="form-group">
                <label for="comments">Commentaires :</label>
                <InputTextArea class="form-control" id="commentaire"
                               @bind-Value=nouveauCalendrier.Commentaire></InputTextArea>
            </div>
            <button @onclick="AjouterCalendrier">Enregistrer</button>
            <button @onclick="GenerateCalendar">Annuler</button>
        </EditForm>
    </div>
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationState { get; set; }
    OnyraProjet.Models.Calendrier? nouveauCalendrier = new OnyraProjet.Models.Calendrier();
    private DateTime currentMonth = DateTime.Today;
    private DateTime selectedDate = DateTime.MinValue;
    // propriétés existantes
    private DateOnly dateCoucher { get; set; }
    private DateOnly dateLever { get; set; }
    private DateTime heureCoucher { get; set; } // contient l'heure (date partie ignorée)
    private DateTime heureLever { get; set; }

    // combinaisons correctes
    private DateTime CoucherComplet => dateCoucher.ToDateTime(TimeOnly.FromDateTime(heureCoucher));
    private DateTime LeverComplet => dateLever.ToDateTime(TimeOnly.FromDateTime(heureLever));

    private string note = "";
    private string[] dayNames = new[] { "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam", "Dim" };
    private List<DateTime> days = new();

    protected override void OnInitialized()
    {
        GenerateCalendar();
    }

    private void GenerateCalendar()
    {
        days.Clear();
        var firstDay = new DateTime(currentMonth.Year, currentMonth.Month, 1);
        int offset = ((int)firstDay.DayOfWeek + 6) % 7; // Commence lundi
        var startDate = firstDay.AddDays(-offset);

        for (int i = 0; i < 42; i++)
        {
            days.Add(startDate.AddDays(i));
        }
    }

    private void PrevMonth()
    {
        currentMonth = currentMonth.AddMonths(-1);
        GenerateCalendar();
    }

    private void NextMonth()
    {
        currentMonth = currentMonth.AddMonths(1);
        GenerateCalendar();
    }

    private void SelectDay(DateTime date)
    {
        selectedDate = date;
        dateLever = DateOnly.FromDateTime(selectedDate);
        dateCoucher = DateOnly.FromDateTime(selectedDate);
        DateOnly dateDB = DateOnly.FromDateTime(selectedDate);
        nouveauCalendrier.Dates = dateDB;
    }

    private void SaveNote()
    {

    }

    private string GetCellStyle(bool isCurrentMonth, bool isSelected)
    {
        string baseStyle = "padding:6px; text-align:center; border:1px solid #ccc; cursor:pointer;";
        if (!isCurrentMonth)
            baseStyle += "color:gray;";
        if (isSelected)
            baseStyle += "background-color:lightblue; font-weight:bold;";
        return baseStyle;
    }
    public async Task AjouterCalendrier()
    {
        Console.WriteLine($"Note pour {selectedDate.ToShortDateString()} : {note}");
        note = "";
        selectedDate = DateTime.MinValue;
        try
        {
            var authState = await authenticationState;
            var idUtil = authState.User.FindFirst(c => c.Type.Contains("nameidentifier"));
            nouveauCalendrier.NoUtilisateur = int.Parse(idUtil.Value);
            nouveauCalendrier.HeureCoucher = CoucherComplet;
            nouveauCalendrier.HeureLever = LeverComplet;
            await calendrierService.AjouterCalendrier(nouveauCalendrier);

        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
        }


    }
}

