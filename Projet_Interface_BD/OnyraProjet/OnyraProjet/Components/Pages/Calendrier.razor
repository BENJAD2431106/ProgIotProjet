@page "/Calendrier"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using System.Globalization
@using Authentication
@using OnyraProjet.Models
@using System.Security.Claims
@inject OnyraProjet.Services.CalendrierService calendrierService
@inject OnyraProjet.Services.VisualisateurCalendrierService visCalService
@inject OnyraProjet.Services.Medecin medecinService
@inject AuthenticationStateProvider AuthService
@rendermode InteractiveServer
@inject NavigationManager nav

<h3 class="mb-3 text-center">Calendrier</h3>

<div class="row">
    <div class="col-6">

        <div class="d-flex justify-content-between align-items-center mb-2">
            <button class="btn btn-outline-primary btn-sm" @onclick="PrevMonth">◀️</button>
            <strong>@currentMonth.ToString("MMMM yyyy", CultureInfo.GetCultureInfo("fr-FR"))</strong>
            <button class="btn btn-outline-primary btn-sm" @onclick="NextMonth">▶️</button>
        </div>

        @if (days == null)
        {

        }
        else
        {
            <table class="table table-bordered text-center">
                <thead class="table-light">
                    <tr>
                        @foreach (var dayName in dayNames)
                        {
                            <th>@dayName</th>
                        }
                    </tr>
                </thead>

                <tbody>
                    @for (int week = 0; week < 6; week++)
                    {
                        <tr>
                            @for (int day = 0; day < 7; day++)
                            {
                                var index = week * 7 + day;
                                var date = days[index];
                                var isCurrentMonth = date.Month == currentMonth.Month;
                                var isSelected = date == selectedDate;

                                string baseStyle = GetCellStyle(isCurrentMonth, isSelected);
                                @if (joursRemplis.Contains(DateOnly.FromDateTime(date)))
                                {
                                    <td style="@($"{baseStyle} background-color:grey; color:white; font-weight:bold;")"
                                        class="p-3"
                                        @onclick="() => SelectDay(date)">
                                        @date.Day
                                    </td>
                                }
                                else
                                {
                                    <td style="@($"{baseStyle}")"
                                        class="p-3"
                                        @onclick="() => SelectDay(date)">
                                        @date.Day
                                    </td>
                                }
                            }
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
    @if (joursRemplis.Contains(DateOnly.FromDateTime(selectedDate)))
    {
        <div class="col-6">

            @if (selectedDate != DateTime.MinValue)
            {
                <div class="p-3 border rounded shadow-sm">
                    <h4 class="mb-3">
                        Visualisateur de Données pour Le
                        @selectedDate.ToString("dd MMMM yyyy", CultureInfo.GetCultureInfo("fr-FR"))
                    </h4>

                </div>
            }
            @if (calendrierJour is not null)
            {
                TimeSpan dureeSommeil = calendrierJour.HeureLever - calendrierJour.HeureCoucher;
                string dureeFormat = $"{(int)dureeSommeil.TotalHours}h {dureeSommeil.Minutes}min";

                <div class="card">
                    <div class="card-body">
                        <p><strong>Date :</strong> @calendrierJour.Dates.ToShortDateString()</p>
                        <p><strong>Heure de coucher :</strong> @calendrierJour.HeureCoucher.ToShortTimeString()</p>
                        <p><strong>Heure de lever :</strong> @calendrierJour.HeureLever.ToShortTimeString()</p>
                        <p><strong>Ressenti :</strong> @calendrierJour.Ressenti</p>
                        <p><strong>Commentaire : </strong> @calendrierJour.Commentaire</p>
                        <p><strong>Sommeil Total : </strong> @dureeFormat</p>
                        <button class="btn btn-warning btn-sm"
                                @onclick="ModifierNuit">
                            Modifier mes données pour cette nuit
                        </button>
                        @if (afficherFormulaireModification == true)
                        {
                                    <div class="card mt-3 p-3">

                                        <h5>Modifier la nuit du @selectedDate.ToShortDateString()</h5>

                                        <label>Note</label>
                                        <input class="form-control" @bind="noteModifiee" />

                                        <label>Date De Coucher</label>
                                        <input type="date" class="form-control"
                                               @bind="dateCoucherModifiee" />

                                        <label>Heure de coucher</label>
                                        <input type="time" class="form-control"
                                               @bind="heureCoucherModifiee" />

                                        <label>Date De Lever</label>
                                        <input type="date" class="form-control"
                                               @bind="dateLeverModifiee" />

                                        <label>Heure de lever</label>
                                        <input type="time" class="form-control"
                                               @bind="heureLeverModifiee" />

                                        <button class="btn btn-success mt-2" @onclick="EnregistrerModifications">
                                            Enregistrer modifications
                                        </button>

                                    </div>
                                }

                            </div>
                        
                        @if (dureeSommeil.TotalHours <= 5)
                        {
                            <p><strong> Duree de sommeil insatisfaisante. </strong></p>
                            <p><strong>Onyra vous conseille fortement de prendre rendez - vous avec un médecin. </strong> </p>
                            <p><strong> Nous vous suggérons de : </strong> </p>

                            <button class="btn btn-danger mt-2"
                                    @onclick="ChargerMedecins">
                                Prendre rendez-vous maintenant
                            </button>
                        }
                        @if (afficherMedecins)
                        {
                            <div class="card mt-3">
                                <div class="card-body">
                                    <h5>Médecins disponibles</h5>

                                    @if (listeMedecins.Count == 0)
                                    {
                                        <p>Aucun médecin disponible.</p>
                                    }
                                    else
                                    {
                                        <ul class="list-group">
                                            <div class="mt-3">
                                                <label>Date du rendez-vous :</label>
                                                <input type="date" @bind="dateRdv" class="form-control" />
                                            </div>
                                            @foreach (var med in listeMedecins)
                                            {
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>@med.NomUtilisateur @med.PrenomUtilisateur </strong><br />
                                                        <small> Disponible.</small>
                                                    </div>

                                                    <button class="btn btn-primary btn-sm"
                                                            @onclick="() => ChoisirMedecin(med.NoUtilisateur)">
                                                        Choisir
                                                    </button>
                                                    <p>@messageMed</p>
                                                </li>
                                            }
                                        </ul>
                                    }
                                </div>
                            </div>
                        }

                    </div>
            }
            else
            {
                <p>Aucune donnée pour cette date.</p>
            }

        </div>
    }
    else
    {
        <div class="col-6">

            @if (selectedDate != DateTime.MinValue)
            {
                <div class="p-3 border rounded shadow-sm">
                    <h4 class="mb-3">
                        Ajouter des données pour le
                        @selectedDate.ToString("dd MMMM yyyy", CultureInfo.GetCultureInfo("fr-FR"))
                    </h4>

                    <EditForm Model="nouveauCalendrier" OnValidSubmit="HandleError">

                        <div class="form-group mb-2">
                            <label for="ressenti">Votre Ressenti :</label>
                            <InputNumber class="form-control" id="ressenti"
                                         @bind-Value=nouveauCalendrier.Ressenti></InputNumber>
                        </div>

                        <div class="form-group mb-2">
                            <label>Date du Coucher</label>
                            <InputDate class="form-control" @bind-Value=dateCoucher></InputDate>

                            <label class="mt-1">Heure du Coucher</label>
                            <input type="time" class="form-control" @bind=heureCoucher />
                        </div>

                        <div class="form-group mb-2">
                            <label>Date du Réveil</label>
                            <InputDate class="form-control" @bind-Value="@dateLever" readonly></InputDate>

                            <label class="mt-1">Heure du Réveil</label>
                            <input type="time" class="form-control" @bind=heureLever />
                        </div>

                        <div class="form-group mb-2">
                            <label for="nbReveil">Nombre de réveils</label>
                            <InputNumber class="form-control" id="nbReveil"
                                         @bind-Value=nouveauCalendrier.NbreReveil></InputNumber>
                        </div>

                        <div class="form-group mb-3">
                            <label for="commentaire">Commentaires :</label>
                            <InputTextArea class="form-control" id="commentaire"
                                           @bind-Value=nouveauCalendrier.Commentaire></InputTextArea>
                        </div>
                        <p class="text-danger text-center">@message</p>
                        <button class="btn btn-success me-2">Enregistrer</button>
                        <button class="btn btn-secondary" @onclick="GenerateCalendar">Annuler</button>

                    </EditForm>
                </div>
            }
        </div>

    }

</div>

@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationState { get; set; }
    private Models.Calendrier? calendrierJour;
    OnyraProjet.Models.Calendrier? nouveauCalendrier = new OnyraProjet.Models.Calendrier();
    private DateOnly? dateRdv = null;
    private int idUtilisateur;
    private DateTime currentMonth = DateTime.Today;
    private DateTime selectedDate = DateTime.MinValue;
    private string message = "";
    private string messageMed = "";
    private List<DateOnly> joursRemplis = new();
    // propriétés existantes
    private DateOnly dateCoucher { get; set; }
    private DateOnly dateLever { get; set; }
    private DateTime heureCoucher { get; set; } // contient l'heure (date partie ignorée)
    private DateTime heureLever { get; set; }
    private bool afficherFormulaireModification = false;
    // combinaisons correctes
    private DateTime CoucherComplet => dateCoucher.ToDateTime(TimeOnly.FromDateTime(heureCoucher));
    private DateTime LeverComplet => dateLever.ToDateTime(TimeOnly.FromDateTime(heureLever));

    private string note = "";
    private string[] dayNames = new[] { "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam", "Dim" };
    private List<DateTime> days = new();

    private bool afficherMedecins = false;
    private List<Utilisateur> listeMedecins = new();
    private Utilisateur? medecinSelectionne = null;

    string? noteModifiee;
    TimeOnly heureCoucherModifiee;
    TimeOnly heureLeverModifiee;
    private DateOnly dateLeverModifiee = DateOnly.FromDateTime(DateTime.Now);
    DateOnly dateCoucherModifiee =DateOnly.FromDateTime(DateTime.Now);
    DateTime dateSelectionnee; // la date que l’utilisateur modifie

    string msgModif = "";
    protected override async Task OnInitializedAsync()
    {
        GenerateCalendar();
        afficherFormulaireModification = false;

        var authState = await authenticationState;
        var user = authState.User;

        if (!user.Identity.IsAuthenticated)
        {
            message = "Vous devez être connecté.";
            return;
        }

        // Recherche robuste
        var idClaim =
            user.FindFirst(ClaimTypes.NameIdentifier) ??
            user.FindFirst(c => c.Type.Contains("nameidentifier")) ??
            user.FindFirst("sub");

        if (idClaim == null)
        {
            message = "Impossible de déterminer l'identifiant utilisateur.";
            return;
        }

        idUtilisateur = int.Parse(idClaim.Value);

        joursRemplis = await calendrierService.SavoirSiRempli(idUtilisateur);
    }


    private void GenerateCalendar()
    {
        days.Clear();
        var firstDay = new DateTime(currentMonth.Year, currentMonth.Month, 1);
        int offset = ((int)firstDay.DayOfWeek + 6) % 7;
        var startDate = firstDay.AddDays(-offset);

        for (int i = 0; i < 42; i++)
        {
            days.Add(startDate.AddDays(i));
        }
    }

    private void PrevMonth()
    {
        currentMonth = currentMonth.AddMonths(-1);
        GenerateCalendar();
    }

    private void NextMonth()
    {
        currentMonth = currentMonth.AddMonths(1);
        GenerateCalendar();
    }

    private async Task SelectDay(DateTime date)
    {

        selectedDate = date;
        if (joursRemplis.Contains(DateOnly.FromDateTime(date)))
        {
            await ChargerDonnees(selectedDate);
        }
        else
        {
            dateLever = DateOnly.FromDateTime(selectedDate);
            dateCoucher = DateOnly.FromDateTime(selectedDate);
            DateOnly dateDB = DateOnly.FromDateTime(selectedDate);
            nouveauCalendrier.Dates = dateDB;
        }

    }

    private void SaveNote()
    {

    }

    private string GetCellStyle(bool isCurrentMonth, bool isSelected)
    {
        string baseStyle = "padding:6px; text-align:center; border:1px solid #ccc; cursor:pointer;";
        if (!isCurrentMonth)
            baseStyle += "color:gray;";
        if (isSelected)
            baseStyle += "background-color:lightblue; font-weight:bold;";
        return baseStyle;
    }
    public async Task AjouterCalendrier()
    {
        Console.WriteLine($"Note pour {selectedDate.ToShortDateString()} : {note}");
        note = "";
        selectedDate = DateTime.MinValue;
        try
        {
            var authState = await authenticationState;
            var idUtil = authState.User.FindFirst(c => c.Type.Contains("nameidentifier"));
            nouveauCalendrier.NoUtilisateur = int.Parse(idUtil.Value);
            nouveauCalendrier.HeureCoucher = CoucherComplet;
            nouveauCalendrier.HeureLever = LeverComplet;
            await calendrierService.AjouterCalendrier(nouveauCalendrier);

        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
        }
        nouveauCalendrier = new Models.Calendrier();
        nav.NavigateTo("/Calendrier", forceLoad: true);
    }
    public async Task HandleError()
    {
        message = string.Empty;
        if (!string.IsNullOrEmpty(nouveauCalendrier.Ressenti.ToString()) && nouveauCalendrier.Ressenti > 10 || nouveauCalendrier.Ressenti < 1)
        {
            message = "Ressenti invalide.";
            return;
        }
        var aujourdHui = DateOnly.FromDateTime(selectedDate);
        var hier = aujourdHui.AddDays(-1);

        if (dateCoucher != aujourdHui && dateCoucher != hier)
        {
            message = "La date de coucher doit être aujourd'hui ou hier.";
            return;
        }

        await AjouterCalendrier();
    }
    public async Task ChargerDonnees(DateTime date)
    {

        try
        {
            calendrierJour = await visCalService.VisualiserDate(date, idUtilisateur);

        }
        catch (Exception e)
        {
            Console.WriteLine(e);
        }
    }
    private async Task ChargerMedecins()
    {
        afficherMedecins = true;
        listeMedecins = await medecinService.GetMedecinsDisponibles();
    }
    private async Task ChoisirMedecin(int idMedecin)
    {
        if (dateRdv is null)
        {
            messageMed = "Veuillez sélectionner une date avant de choisir un médecin.";
            return;
        }

        await medecinService.EnregistrerMedecin(idUtilisateur, idMedecin, dateRdv.Value);

        messageMed = "Médecin enregistré avec rendez-vous.";
    }

    private async Task ModifierNuit()
    {
        afficherFormulaireModification = true;

        // Charger les données existantes
        noteModifiee = calendrierJour.Commentaire;

        // Séparer date + heure pour les inputs
        dateCoucherModifiee = DateOnly.FromDateTime(calendrierJour.HeureCoucher);
        heureCoucherModifiee = TimeOnly.FromDateTime(calendrierJour.HeureCoucher);

        dateLeverModifiee = DateOnly.FromDateTime(calendrierJour.HeureLever);
        heureLeverModifiee = TimeOnly.FromDateTime(calendrierJour.HeureLever);
    }

    private void ModifierNuit(DateTime date, Models.Calendrier data)
    {
        dateSelectionnee = date;

        noteModifiee = data.Commentaire;
        // heureCoucherModifiee = data.HeureCoucher;
        // heureLeverModifiee = data.HeureLever;

        afficherFormulaireModification = true;
    }

    private async Task EnregistrerModifications()
    {
        bool ok = await calendrierService.ModifierCalendrier(
            idUtilisateur,
            DateOnly.FromDateTime(selectedDate),
            noteModifiee,
            heureCoucherModifiee,
            heureLeverModifiee,
            dateCoucherModifiee,
            dateLeverModifiee
        );

        if (ok)
        {
            message = "Modifications enregistrées!";
        }
        else
        {
            message = "Aucune donnée à modifier pour cette date.";
        }

        afficherFormulaireModification = false;
    }



}