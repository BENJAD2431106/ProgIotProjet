@page "/AjoutCalendrier"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using System.Globalization
@using Authentication
@using OnyraProjet.Models
@using System.Security.Claims

@inject OnyraProjet.Services.InscriptionService inscriptionService
@inject OnyraProjet.Services.CalendrierService calendrierService
@inject AuthenticationStateProvider AuthService
@rendermode InteractiveServer

<h3 class="mb-3 text-center">Calendrier</h3>

<div class="row">
    <div class="col-6">

        <div class="d-flex justify-content-between align-items-center mb-2">
            <button class="btn btn-outline-primary btn-sm" @onclick="PrevMonth">◀️</button>
            <strong>@currentMonth.ToString("MMMM yyyy", CultureInfo.GetCultureInfo("fr-FR"))</strong>
            <button class="btn btn-outline-primary btn-sm" @onclick="NextMonth">▶️</button>
        </div>

        <table class="table table-bordered text-center">
            <thead class="table-light">
                <tr>
                    @foreach (var dayName in dayNames)
                    {
                        <th>@dayName</th>
                    }
                </tr>
            </thead>

            <tbody>
                @for (int week = 0; week < 6; week++)
                {
                    <tr>
                        @for (int day = 0; day < 7; day++)
                        {
                            var index = week * 7 + day;
                            var date = days[index];
                            var isCurrentMonth = date.Month == currentMonth.Month;
                            var isSelected = date == selectedDate;

                            string baseStyle = GetCellStyle(isCurrentMonth, isSelected);

                            <td style="@($"{baseStyle}")"
                                class="p-3"
                                @onclick="() => SelectDay(date)">
                                @date.Day
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="col-6">

        @if (selectedDate != DateTime.MinValue)
        {
            <div class="p-3 border rounded shadow-sm">
                <h4 class="mb-3">
                    Ajouter des données pour le
                    @selectedDate.ToString("dd MMMM yyyy", CultureInfo.GetCultureInfo("fr-FR"))
                </h4>

                <EditForm Model="nouveauCalendrier" OnValidSubmit="HandleError">

                    <div class="form-group mb-2">
                        <label for="ressenti">Votre Ressenti :</label>
                        <InputNumber class="form-control" id="ressenti"
                                     @bind-Value=nouveauCalendrier.Ressenti></InputNumber>
                    </div>

                    <div class="form-group mb-2">
                        <label>Date du Coucher</label>
                        <InputDate class="form-control" @bind-Value=dateCoucher></InputDate>

                        <label class="mt-1">Heure du Coucher</label>
                        <input type="time" class="form-control" @bind=heureCoucher />
                    </div>

                    <div class="form-group mb-2">
                        <label>Date du Réveil</label>
                        <InputDate class="form-control" @bind-Value=dateLever></InputDate>

                        <label class="mt-1">Heure du Réveil</label>
                        <input type="time" class="form-control" @bind=heureLever />
                    </div>

                    <div class="form-group mb-2">
                        <label for="nbReveil">Nombre de réveils</label>
                        <InputNumber class="form-control" id="nbReveil"
                                     @bind-Value=nouveauCalendrier.NbreReveil></InputNumber>
                    </div>

                    <div class="form-group mb-3">
                        <label for="commentaire">Commentaires :</label>
                        <InputTextArea class="form-control" id="commentaire"
                                       @bind-Value=nouveauCalendrier.Commentaire></InputTextArea>
                    </div>
                    <p class="text-danger text-center">@message</p>
                    <button class="btn btn-success me-2">Enregistrer</button>
                    <button class="btn btn-secondary" @onclick="GenerateCalendar">Annuler</button>

                </EditForm>
            </div>
        }
    </div>
</div>

@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationState { get; set; }
    string message = "";
    OnyraProjet.Models.Calendrier? nouveauCalendrier = new OnyraProjet.Models.Calendrier();
    private DateTime currentMonth = DateTime.Today;
    private DateTime selectedDate = DateTime.MinValue;
    // propriétés existantes
    private DateOnly dateCoucher { get; set; }
    private DateOnly dateLever { get; set; }
    private DateTime heureCoucher { get; set; } // contient l'heure (date partie ignorée)
    private DateTime heureLever { get; set; }

    // combinaisons correctes
    private DateTime CoucherComplet => dateCoucher.ToDateTime(TimeOnly.FromDateTime(heureCoucher));
    private DateTime LeverComplet => dateLever.ToDateTime(TimeOnly.FromDateTime(heureLever));

    private string note = "";
    private string[] dayNames = new[] { "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam", "Dim" };
    private List<DateTime> days = new();

    protected override void OnInitialized()
    {
        GenerateCalendar();
    }

    private void GenerateCalendar()
    {
        days.Clear();
        var firstDay = new DateTime(currentMonth.Year, currentMonth.Month, 1);
        int offset = ((int)firstDay.DayOfWeek + 6) % 7;
        var startDate = firstDay.AddDays(-offset);

        for (int i = 0; i < 42; i++)
        {
            days.Add(startDate.AddDays(i));
        }
    }

    private void PrevMonth()
    {
        currentMonth = currentMonth.AddMonths(-1);
        GenerateCalendar();
    }

    private void NextMonth()
    {
        currentMonth = currentMonth.AddMonths(1);
        GenerateCalendar();
    }

    private void SelectDay(DateTime date)
    {
        selectedDate = date;
        dateLever = DateOnly.FromDateTime(selectedDate);
        dateCoucher = DateOnly.FromDateTime(selectedDate);
        DateOnly dateDB = DateOnly.FromDateTime(selectedDate);
        nouveauCalendrier.Dates = dateDB;
    }

    private void SaveNote()
    {

    }

    private string GetCellStyle(bool isCurrentMonth, bool isSelected)
    {
        string baseStyle = "padding:6px; text-align:center; border:1px solid #ccc; cursor:pointer;";
        if (!isCurrentMonth)
            baseStyle += "color:gray;";
        if (isSelected)
            baseStyle += "background-color:lightblue; font-weight:bold;";
        return baseStyle;
    }
    public async Task AjouterCalendrier()
    {
        Console.WriteLine($"Note pour {selectedDate.ToShortDateString()} : {note}");
        note = "";
        selectedDate = DateTime.MinValue;
        try
        {
            var authState = await authenticationState;
            var idUtil = authState.User.FindFirst(c => c.Type.Contains("nameidentifier"));
            nouveauCalendrier.NoUtilisateur = int.Parse(idUtil.Value);
            nouveauCalendrier.HeureCoucher = CoucherComplet;
            nouveauCalendrier.HeureLever = LeverComplet;
            await calendrierService.AjouterCalendrier(nouveauCalendrier);

        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
        }
        nouveauCalendrier = new Models.Calendrier();

    }
    public async Task HandleError()
    {
        message = string.Empty;
        if (!string.IsNullOrEmpty(nouveauCalendrier.Ressenti.ToString()) && nouveauCalendrier.Ressenti > 10 || nouveauCalendrier.Ressenti < 1)
        {
            message = "Ressenti invalide.";
            return;
        }

        await AjouterCalendrier();
    }
}

@* //jarrive pas a faire une deuxieme insertion. DONE.
apres : -trouver comment afficher autre couleur si deja rempli(jour)
-si rempli rediriger vers page affichage: Temps sommeil total. hLever. hCoucher et donnees + condition pour sommeil bon ou pas bon.
-si sommeil pas bon onlick prendre rendez-vous medecin.
-capturer erreurs calendrier insertion.

 *@